# Threads Post Lookup Skill - Multi-Strategy Extraction
# Tier 1: HTTP fetch primary, browser automation fallback
# v6.0.0: Robust extraction with fallback strategies

name: threads-lookup
version: 6.0.0
description: Extract and analyze Threads posts with multi-strategy approach

triggers:
  - type: pattern
    value: "threads\\.(net|com)"
  - type: keyword
    value: "threads post"

inputs:
  url:
    type: string
    required: true
    description: Threads post URL
  pillar:
    type: string
    required: false
    description: Life domain (The Grove, Consulting, Personal, Home/Garage)
  depth:
    type: string
    required: false
    default: "standard"
    description: Extraction depth (shallow, standard, deep)
  feedId:
    type: string
    required: false
    description: Feed entry ID to update with extraction results
  workQueueId:
    type: string
    required: false
    description: Work Queue entry ID if applicable
  telegramChatId:
    type: number
    required: false
    description: Chat ID for sending completion notification

outputs:
  - type: feed_entry
    description: Enriched post content logged to Feed
  - type: data
    description: Extracted content and analysis

process:
  type: tool_sequence
  timeout: 120000
  steps:
    # Strategy 1: Try HTTP fetch first (fast, works if Threads returns content)
    - id: http_fetch
      tool: web_fetch
      inputs:
        url: "$input.url"
        extractText: true
        timeout: 15000
      onError: continue

    # Check if HTTP fetch got meaningful content (>100 chars)
    - id: check_http
      condition: "$step.http_fetch.success == true"
      then:
        # HTTP worked - analyze the content
        - id: analyze_http
          tool: claude_analyze
          inputs:
            content: "$step.http_fetch.text"
            systemPrompt: |
              Analyze this Threads post content. The content may be partial or contain navigation elements.
              Extract what you can:

              1. **Author**: Username/handle if visible
              2. **Main Message**: Core point or argument (2-3 sentences)
              3. **Key Insights**: Notable quotes, claims, or data points
              4. **Relevance to $input.pillar**: How this relates to the user's domain
              5. **Suggested Actions**: 2-3 specific next steps

              Format with clear headers. If content is minimal, note what's missing.
              Be concise but actionable.
          onError: continue

        # Update Feed status
        - id: update_feed_http
          tool: notion_update
          inputs:
            pageId: "$input.feedId"
            properties:
              Extraction Status: "complete"
              Extraction Depth: "$input.depth"
          onError: continue

        # Append analysis to Feed
        - id: append_http
          tool: notion_append
          inputs:
            pageId: "$input.feedId"
            heading: "üßµ Threads Analysis"
            callout: "Pillar: $input.pillar | Depth: $input.depth | Method: HTTP fetch"
            calloutEmoji: "üìã"
            content: "$step.analyze_http.output"
          onError: continue

        # Notify user
        - id: notify_http
          tool: telegram_send
          inputs:
            chatId: "$input.telegramChatId"
            message: |
              üßµ Threads extraction complete

              $step.analyze_http.output
          onError: continue

      else:
        # HTTP failed - try browser automation
        - id: browser_open
          tool: browser_open_page
          inputs:
            url: "$input.url"
            timeout: 45000
          onError: continue

        # Check browser result
        - id: check_browser
          condition: "$step.browser_open.success == true"
          then:
            # Browser worked - extract text
            - id: browser_text
              tool: browser_get_text
              inputs:
                pageId: "$step.browser_open.pageId"
              onError: continue

            # Analyze browser content
            - id: analyze_browser
              tool: claude_analyze
              inputs:
                content: "$step.browser_text.output"
                systemPrompt: |
                  Analyze this Threads post content extracted from browser.

                  1. **Author**: Username/handle if visible
                  2. **Main Message**: Core point or argument (2-3 sentences)
                  3. **Key Insights**: Notable quotes, claims, or data points
                  4. **Relevance to $input.pillar**: How this relates to the user's domain
                  5. **Suggested Actions**: 2-3 specific next steps

                  Format with clear headers. Be concise but actionable.
              onError: continue

            # Update Feed status
            - id: update_feed_browser
              tool: notion_update
              inputs:
                pageId: "$input.feedId"
                properties:
                  Extraction Status: "complete"
                  Extraction Depth: "$input.depth"
              onError: continue

            # Append analysis
            - id: append_browser
              tool: notion_append
              inputs:
                pageId: "$input.feedId"
                heading: "üßµ Threads Analysis"
                callout: "Pillar: $input.pillar | Depth: $input.depth | Method: Browser automation"
                calloutEmoji: "üìã"
                content: "$step.analyze_browser.output"
              onError: continue

            # Notify
            - id: notify_browser
              tool: telegram_send
              inputs:
                chatId: "$input.telegramChatId"
                message: |
                  üßµ Threads extraction complete

                  $step.analyze_browser.output
              onError: continue

            # Cleanup
            - id: cleanup_browser
              tool: browser_close_page
              inputs:
                pageId: "$step.browser_open.pageId"
              always_run: true
              onError: continue

          else:
            # Both methods failed - mark as failed with explanation
            - id: update_feed_failed
              tool: notion_update
              inputs:
                pageId: "$input.feedId"
                properties:
                  Extraction Status: "failed"
                  Extraction Depth: "$input.depth"
              onError: continue

            - id: append_failed
              tool: notion_append
              inputs:
                pageId: "$input.feedId"
                heading: "üßµ Threads Analysis - Failed"
                callout: "Could not extract content from this Threads post"
                calloutEmoji: "‚ö†Ô∏è"
                content: |
                  **Extraction failed**

                  Both HTTP fetch and browser automation were unable to extract content from this Threads post.

                  **Possible reasons:**
                  - Post may be private or deleted
                  - Threads may be blocking automated access
                  - Network/connectivity issues

                  **Suggested Actions:**
                  1. Open the link manually to verify it's accessible
                  2. If it's a valuable post, copy the content manually
                  3. Consider saving as a screenshot instead
              onError: continue

            - id: notify_failed
              tool: telegram_send
              inputs:
                chatId: "$input.telegramChatId"
                message: |
                  ‚ö†Ô∏è Threads extraction failed

                  Could not extract content from this post. Please check the link manually.
              onError: continue

enabled: true
tier: 1
tags:
  - social
  - threads
  - pillar-aware
  - contextual-extraction
  - multi-strategy
